---
title: "Exploraci√≥n Auxiliar de gapminder"
subtitle: "An√°lisis complementario para interpretaci√≥n de resultados"
format: html
editor: visual
---

## Introducci√≥n

Este documento auxiliar permite realizar exploraciones adicionales sobre el dataset `gapminder`, facilitando la interpretaci√≥n de resultados y la generaci√≥n de visualizaciones complementarias.

### Carga de librer√≠as y datos

```{r, warning=FALSE, message=FALSE, echo=FALSE}
library(tidyverse)
library(gapminder)
library(ggplot2)
library(plotly)
library(e1071)
library(nortest)
library(lmtest)
library(ggrepel)
library(ggridges)
library(gghalves)
library(ggalluvial)
library(scales)
data(gapminder)

set.seed(42)  # reproducibilidad del muestreo
```

------------------------------------------------------------------------

## 1. Pa√≠ses que cumplen condiciones espec√≠ficas

Por ejemplo, para la pregunta 1 de la tarea principal:

Filtrar los pa√≠ses asi√°ticos en 2007 con esperanza de vida mayor a 70 y PBI per c√°pita mayor a 5000:

```{r}
# Filtrar pa√≠ses seg√∫n condici√≥n
paises_filtrados <- gapminder %>%
  filter(continent == "Asia", year == 2007, lifeExp > 70, gdpPercap > 5000)

paises_filtrados %>% select(country, lifeExp, gdpPercap)
```

### Visualizaci√≥n: Scatterplot de Esperanza de Vida vs PBI per c√°pita

```{r}
# Calcular medianas
mediana_lifeExp <- median(paises_filtrados$lifeExp)
mediana_gdpPercap <- median(paises_filtrados$gdpPercap)

# Scatterplot con leyenda interior de medianas y tendencia LOESS
ggplot(paises_filtrados, aes(x = gdpPercap, y = lifeExp)) +
  geom_point(color = 'blue', size = 5) +
  geom_text(aes(label = country), nudge_y = 1, size = 5) +
  geom_hline(aes(yintercept = mediana_lifeExp, color = "Mediana lifeExp"),
             linewidth = 0.7, alpha = 0.5) +
  geom_vline(aes(xintercept = mediana_gdpPercap, color = "Mediana gdpPercap"),
             linewidth = 0.7, alpha = 0.5) +
  geom_smooth(aes(color = "Tendencia LOESS"), method = "loess", se = TRUE, linewidth = 0.7, alpha = 0.5) +
  labs(
    title = "Pa√≠ses asi√°ticos en 2007\ncon lifeExp > 70 y gdpPercap > 5000",
    x = "PBI per c√°pita",
    y = "Esperanza de vida",
    color = NULL) +
  theme_minimal(base_size = 20) +
  theme(
    legend.position = c(0.85, 0.05),
    legend.background = element_rect(fill = "white", color = "black", linewidth = 0.5)
  )
```

### Versi√≥n interactiva

```{r}
# Interactive: replica de la gr√°fica est√°tica con Plotly
# Calcular medianas
mediana_lifeExp <- median(paises_filtrados$lifeExp)
mediana_gdpPercap <- median(paises_filtrados$gdpPercap)

p <- ggplot(paises_filtrados, aes(x = gdpPercap, y = lifeExp, text = country)) +
  geom_point(color = 'blue', size = 5) +
  geom_hline(aes(yintercept = mediana_lifeExp, color = "Mediana lifeExp"), linewidth = 0.7, alpha = 0.5) +
  geom_vline(aes(xintercept = mediana_gdpPercap, color = "Mediana gdpPercap"), linewidth = 0.7, alpha = 0.5) +
  labs(
    title = "Pa√≠ses asi√°ticos en 2007\ncon lifeExp > 70 y gdpPercap > 5000",
    x = "PBI per c√°pita",
    y = "Esperanza de vida",
    color = NULL) +
  theme_minimal(base_size = 12) +
  theme(
    legend.position.inside = c(0.95, 0.05),
    legend.background = element_rect(fill = "white", color = "black", linewidth = 0.5)
  )

ggplotly(p, tooltip = "text") %>%
  layout(legend = list(
    x = 0.95, y = 0.05,
    xanchor = "right", yanchor = "bottom",
    bgcolor = "white", bordercolor = "black", borderwidth = 0.5
  ))
```

------------------------------------------------------------------------

## An√°lisis exploratorio de la variable `lifeExp`

### Visualizaci√≥n de la distribuci√≥n de `lifeExp`

```{r}
ggplot(gapminder, aes(x = lifeExp)) +
  geom_density(fill = 'skyblue', color = 'darkred', alpha = 0.6, linewidth = 1) +
  labs(
    title = 'Densidad de la esperanza de vida (lifeExp)',
    x = 'Esperanza de vida (lifeExp)',
    y = 'Densidad'
  ) +
  theme_minimal()
```

### Test de normalidad para `lifeExp`

```{r}
# Tama√±o de muestra utilizado para los tests
tamano_muestra <- min(5000, length(gapminder$lifeExp))
tamano_muestra

# Test de Shapiro-Wilk (solo para n <= 5000)
shapiro_test <- shapiro.test(sample(gapminder$lifeExp, tamano_muestra))
shapiro_test

# Test de Kolmogorov-Smirnov
ks_test <- ks.test(scale(gapminder$lifeExp), "pnorm")
ks_test

# Test de Anderson-Darling
ad_test <- ad.test(gapminder$lifeExp)
ad_test
```

> **Tama√±o de muestra utilizado:** Para ambos tests se utiliz√≥ una muestra de `r tamano_muestra` observaciones de la variable lifeExp.
>
> **Interpretaci√≥n de los resultados:** - **Shapiro-Wilk normality test:** - Estad√≠stico W = 0.95248, p-value \< 2.2e-16 - El p-valor extremadamente bajo indica que rechazamos la hip√≥tesis nula de normalidad. Por tanto, la distribuci√≥n de `lifeExp` no es normal (al menos para la muestra evaluada). - **Kolmogorov-Smirnov test:** - Estad√≠stico D = 0.1049, p-value \< 2.2e-16 - Tambi√©n rechaza la hip√≥tesis nula de normalidad para la variable estandarizada.
>
> -   **Anderson-Darling normality test:**
>     -   Estad√≠stico A = 28.009, p-value \< 2.2e-16
>     -   El resultado refuerza la evidencia contra la normalidad, con un p-valor extremadamente bajo que indica una fuerte discrepancia respecto a la distribuci√≥n normal, especialmente en las colas.

```{r}
# Q-Q plot
par(mfrow = c(1, 2))
qqnorm(gapminder$lifeExp, main = "QQ-plot de lifeExp")
qqline(gapminder$lifeExp, col = "red")
qqnorm(scale(gapminder$lifeExp), main = "QQ-plot de lifeExp estandarizada")
qqline(scale(gapminder$lifeExp), col = "blue")
par(mfrow = c(1, 1))

kurtosis(gapminder$lifeExp)
```

> **An√°lisis visual (Q-Q plots):**\
> En ambos gr√°ficos (para `lifeExp` y su versi√≥n estandarizada) se observa una **curvatura en forma de S**, lo que indica que los datos se desv√≠an sistem√°ticamente de la l√≠nea te√≥rica que representar√≠a una distribuci√≥n normal. En particular: - En la cola inferior (cuantiles m√°s bajos), los puntos est√°n **por debajo** de la l√≠nea ‚Üí hay m√°s valores bajos de lo esperado bajo normalidad. - En la cola superior (cuantiles m√°s altos), los puntos est√°n **por encima** de la l√≠nea ‚Üí hay m√°s valores altos de lo esperado.
>
> Sin embargo, el **exceso de curtosis negativo** observado (‚àí1.13) indica que la distribuci√≥n es **platic√∫rtica**, es decir, tiene colas **m√°s livianas** y una **menor concentraci√≥n alrededor de la media** en comparaci√≥n con una distribuci√≥n normal. La forma de los Q-Q plots puede entonces explicarse por esta menor curtosis y una posible **asimetr√≠a leve**.
>
> **Conclusi√≥n:** Tanto los tests estad√≠sticos como la evidencia visual aportada por los Q-Q plots indican de forma consistente que la variable `lifeExp` **no sigue una distribuci√≥n normal**. Esto debe tenerse en cuenta al seleccionar m√©todos estad√≠sticos posteriores, especialmente aquellos que asumen normalidad. Dado el exceso de curtosis negativo y la desviaci√≥n en los cuantiles extremos, podr√≠an considerarse m√©todos no param√©tricos, transformaciones o enfoques robustos.

## 2. Nueva variable `ingreso_total`

```{r}
# Crear variable ingreso_total y filtrar valores v√°lidos
aux_gapminder <- gapminder %>%
  mutate(
    ingreso_total = gdpPercap * pop,
    log_ingreso_total = log(ingreso_total),
    log_lifeExp = log(lifeExp)
  ) %>%
  filter(is.finite(log_ingreso_total), is.finite(log_lifeExp))
```

### Test de normalidad para `ingreso_total`

```{r}
# Tama√±o de muestra utilizado para los tests
tamano_muestra <- min(5000, length(aux_gapminder$ingreso_total))
tamano_muestra

# Test de Shapiro-Wilk (solo para n <= 5000)
shapiro_test <- shapiro.test(sample(aux_gapminder$ingreso_total, tamano_muestra))
shapiro_test

# Test de Kolmogorov-Smirnov
ks_test <- ks.test(scale(aux_gapminder$ingreso_total), "pnorm")
ks_test

# Test de Anderson-Darling
ad_test <- ad.test(aux_gapminder$ingreso_total)
ad_test

# Q-Q plot
par(mfrow = c(1, 2))
qqnorm(aux_gapminder$ingreso_total, main = "QQ-plot de ingreso_total")
qqline(aux_gapminder$ingreso_total, col = "red")
qqnorm(scale(aux_gapminder$ingreso_total), main = "QQ-plot de ingreso_total estandarizada")
qqline(scale(aux_gapminder$ingreso_total), col = "blue")
par(mfrow = c(1, 1))

kurtosis(aux_gapminder$ingreso_total)
```

> **Normalidad de la variable `ingreso_total`:**
>
> Se evalu√≥ la normalidad de la variable `ingreso_total` mediante los tests de Shapiro-Wilk, Kolmogorov-Smirnov y Anderson-Darling, utilizando una muestra de `r tamano_muestra` observaciones. En todos los casos, el **p-valor fue menor a 2.2e-16**, lo que indica una **fuerte desviaci√≥n respecto a la normalidad**. El valor extremadamente alto de curtosis (‚âà 136) revela una distribuci√≥n con colas extremadamente pesadas y fuerte asimetr√≠a, lo cual tambi√©n se refleja en los Q-Q plots.
>
> Dado este comportamiento, se aplic√≥ una **transformaci√≥n logar√≠tmica** a la variable. Esta transformaci√≥n reduce la asimetr√≠a y la curtosis, acercando la distribuci√≥n a la normalidad, como se observa en los nuevos Q-Q plots y puede corroborarse mediante nuevos tests de normalidad.

### Test de normalidad para `log_ingreso_total` y `log_lifeExp`

#### Tests para log_ingreso_total

```{r}
# Tama√±o de muestra (m√°ximo 5000) seg√∫n log_ingreso_total
tamano_muestra <- min(5000, nrow(aux_gapminder))
tamano_muestra

# Tests para log_ingreso_total

# Shapiro-Wilk
shapiro_log_ing <- shapiro.test(sample(aux_gapminder$log_ingreso_total, tamano_muestra))
shapiro_log_ing

# Kolmogorov-Smirnov
ks_log_ing <- ks.test(scale(aux_gapminder$log_ingreso_total), "pnorm")
ks_log_ing

# Anderson-Darling
ad_log_ing <- ad.test(aux_gapminder$log_ingreso_total)
ad_log_ing

# Curtosis
curtosis_log_ing <- kurtosis(aux_gapminder$log_ingreso_total)
cat("Curtosis (log_ingreso_total):", curtosis_log_ing, "\n")

# Q-Q plots
par(mfrow = c(1, 2))
qqnorm(aux_gapminder$log_ingreso_total, main = "QQ-plot de log_ingreso_total")
qqline(aux_gapminder$log_ingreso_total, col = "red")
qqnorm(scale(aux_gapminder$log_ingreso_total), main = "QQ-plot de log_ingreso_total (est.)")
qqline(scale(aux_gapminder$log_ingreso_total), col = "blue")
par(mfrow = c(1, 1))
```

#### Tests para log_lifeExp

```{r}
# Shapiro-Wilk
shapiro_log_life <- shapiro.test(sample(aux_gapminder$log_lifeExp, tamano_muestra))
shapiro_log_life

# Kolmogorov-Smirnov
ks_log_life <- ks.test(scale(aux_gapminder$log_lifeExp), "pnorm")
ks_log_life

# Anderson-Darling
ad_log_life <- ad.test(aux_gapminder$log_lifeExp)
print(ad_log_life)

# Curtosis
curtosis_log_life <- kurtosis(aux_gapminder$log_lifeExp)
cat("Curtosis (log_lifeExp):", curtosis_log_life, "\n")

# Q-Q plots
par(mfrow = c(1, 2))
qqnorm(aux_gapminder$log_lifeExp, main = "QQ-plot de log_lifeExp")
qqline(aux_gapminder$log_lifeExp, col = "red")
qqnorm(scale(aux_gapminder$log_lifeExp), main = "QQ-plot de log_lifeExp (est.)")
qqline(scale(aux_gapminder$log_lifeExp), col = "blue")
par(mfrow = c(1, 1))
```

### üìà Interpretaci√≥n de las transformaciones de `lifeExp` e `ingreso_total`

> **Transformaci√≥n de `lifeExp`:**\
> Aunque se aplic√≥ la transformaci√≥n logar√≠tmica, los tests de normalidad (Shapiro-Wilk, Kolmogorov-Smirnov y Anderson-Darling) siguen rechazando la hip√≥tesis de normalidad de `log_lifeExp` con p-valores \< 2.2e-16. Adem√°s, la curtosis solo pas√≥ de -1.13 a -0.66, indicando una platicurtosis a√∫n moderada. Visualmente, los Q-Q plots muestran que la transformaci√≥n no alter√≥ sustancialmente la forma o la tendencia de la distribuci√≥n original. **Por tanto, en este caso, la transformaci√≥n logar√≠tmica no consigui√≥ acercar `lifeExp` a la normalidad.**

> **Transformaci√≥n de `ingreso_total`:**\
> En contraste, `ingreso_total` presentaba inicialmente una distribuci√≥n extremadamente sesgada y leptoc√∫rtica (curtosis ‚âà 136), lo que fue confirmado por todos los tests de normalidad y los Q-Q plots.\
> Tras aplicar la transformaci√≥n logar√≠tmica (`log_ingreso_total`), se observ√≥ una **mejora significativa**: - El p-valor del test de Shapiro-Wilk aument√≥ a 0.1131 (no se rechaza normalidad). - El Kolmogorov-Smirnov entreg√≥ un p-valor de 0.285 (no rechaza normalidad). - El Anderson-Darling a√∫n rechaza marginalmente (p = 0.01964), pero con un estad√≠stico mucho menor (A ‚âà 0.92). - La curtosis (en exceso) baj√≥ a -0.14, acerc√°ndose a la de una distribuci√≥n normal.
>
> **Conclusi√≥n:** Mientras que la transformaci√≥n logar√≠tmica tuvo poco impacto sobre `lifeExp`, en `ingreso_total` logr√≥ corregir severas desviaciones, acercando la variable a una distribuci√≥n normal. Este contraste ilustra la importancia de analizar caso por caso el efecto de las transformaciones.

### Ajuste de modelo log-log y an√°lisis de residuos

```{r}
# Ajustar regresi√≥n lineal simple
modelo <- lm(log_lifeExp ~ log_ingreso_total, data = aux_gapminder)

# Mostrar resumen del modelo
summary(modelo)
```

> **Modelo ajustado:**\
> Se ajust√≥ un modelo de regresi√≥n lineal simple con `log_lifeExp` como variable dependiente y `log_ingreso_total` como variable independiente. El modelo resultante fue: \[ \widehat{\log(\text{lifeExp})} = 2.392 + 0.070 \cdot \log(\text{ingreso\_total}) \] donde ambos coeficientes resultaron altamente significativos (p-valor \< 2.2e-16).

> **Interpretaci√≥n econ√≥mica:**\
> En este contexto log-log, el coeficiente de `log_ingreso_total` (‚âà 0.07) representa una **elasticidad**: un aumento del 1% en el ingreso total se asocia, en promedio, con un aumento de aproximadamente **0.07% en la esperanza de vida**.

> **Bondad de ajuste:**\
> El modelo explica cerca del 38% de la variabilidad en `log_lifeExp` (R¬≤ = 0.3838), lo cual es moderado para datos agregados a nivel pa√≠s-a√±o, donde es esperable una gran heterogeneidad.

```{r}
# Normalidad de los residuos
lillie_test <- lillie.test(residuals(modelo))
lillie_test

# Homocedasticidad: Test de Breusch-Pagan
bptest(modelo)

# Visualizaci√≥n de residuos
par(mfrow = c(1, 2))
plot(modelo$fitted.values, residuals(modelo),
     main = "Residuos vs Ajustados", xlab = "Valores ajustados", ylab = "Residuos")
abline(h = 0, lty = 2, col = 'red')
qqnorm(residuals(modelo), main = "QQ-plot de residuos")
qqline(residuals(modelo), col = 'blue')
par(mfrow = c(1, 1))
```

> **Normalidad:**\
> El test de Lilliefors (D = 0.0501, p \< 1e-10) rechaza la normalidad de los residuos. Esto indica que, aunque la relaci√≥n entre las variables es lineal en escala logar√≠tmica, los residuos **no son perfectamente normales**.

> **Homocedasticidad:**\
> El test de Breusch-Pagan (BP = 68.25, p \< 2.2e-16) tambi√©n rechaza la hip√≥tesis de homocedasticidad, indicando **presencia de heterocedasticidad**. Esto se confirma visualmente en el gr√°fico de "residuos vs ajustados", donde se aprecia una dispersi√≥n creciente.

> **Visualizaci√≥n:**\
> - El **gr√°fico de residuos vs valores ajustados** muestra un patr√≥n de abanico, t√≠pico de heterocedasticidad. - El **Q-Q plot de los residuos** revela desviaciones de la normalidad en las colas, consistentes con los resultados del test de Lilliefors.

### Visualizaci√≥n de la relaci√≥n entre log(ingreso_total) y log(lifeExp)

```{r}
# Visualizar la relaci√≥n y la recta de regresi√≥n
ggplot(aux_gapminder, aes(x = log_ingreso_total, y = log_lifeExp)) +
  geom_point(alpha = 0.3, color = 'darkred') +
  geom_smooth(method = "lm", se = TRUE, color = "blue") +
  labs(
    title = "Relaci√≥n entre log(ingreso_total) y log(lifeExp)",
    x = "log(ingreso_total)",
    y = "log(lifeExp)"
  ) +
  theme_minimal()
```

> El gr√°fico de dispersi√≥n entre `log_ingreso_total` y `log_lifeExp`, junto con la recta de regresi√≥n, confirma una relaci√≥n **positiva y aproximadamente lineal** en la escala logar√≠tmica. El uso del logaritmo mejora claramente la linealidad y permite interpretar la pendiente en t√©rminos de elasticidad.

### Conclusi√≥n general de las transformaciones y el ajuste log-log

-   Existe una relaci√≥n positiva y estad√≠sticamente significativa entre el ingreso total y la esperanza de vida cuando ambas variables son logar√≠tmicas.
-   El modelo capta una proporci√≥n moderada de la variabilidad, pero sus residuos presentan problemas de normalidad y homocedasticidad.
-   A pesar de estos problemas, el ajuste log-log es conceptualmente apropiado para capturar la relaci√≥n econ√≥mica subyacente. Para una modelizaci√≥n m√°s rigurosa, se podr√≠a considerar:
    -   Uso de errores robustos (HC standard errors),
    -   Modelos de regresi√≥n robusta,
    -   O transformaciones adicionales para corregir la heterocedasticidad.

------------------------------------------------------------------------

## Visualizaciones sobre la categorizaci√≥n de esperanza de vida (Ejercicio 1.3)

### 1. L√≠nea apilada: proporci√≥n de categor√≠as a lo largo del tiempo

```{r}
# Data frame con categor√≠a
exp_cat_df <- gapminder %>%
  mutate(
    exp_cat = case_when(
      lifeExp < 50 ~ "baja",
      lifeExp >= 50 & lifeExp < 70 ~ "media",
      lifeExp >= 70 ~ "alta"
    )
  )

# Proporci√≥n por a√±o y categor√≠a
prop_exp_time <- exp_cat_df %>%
  group_by(year, exp_cat) %>%
  summarise(n = n(), .groups = "drop") %>%
  group_by(year) %>%
  mutate(prop = n / sum(n))

# Definir paleta consistente
colores_exp_cat <- c("baja" = "#e74c3c", "media" = "#f1c40f", "alta" = "#27ae60")

# L√≠nea apilada con colores fijos
ggplot(prop_exp_time, aes(x = year, y = prop, fill = exp_cat)) +
  geom_area(alpha = 0.7, color = "grey40") +
  labs(
    title = "Proporci√≥n de categor√≠as de esperanza de vida a lo largo del tiempo",
    x = "A√±o",
    y = "Proporci√≥n",
    fill = "Categor√≠a"
  ) +
  scale_y_continuous(labels = scales::percent_format()) +
  scale_fill_manual(values = colores_exp_cat) +
  theme_minimal(base_size = 14)
```

Este gr√°fico permite visualizar c√≥mo la distribuci√≥n de las categor√≠as de esperanza de vida (baja, media, alta) evoluciona a lo largo del tiempo, facilitando la identificaci√≥n de tendencias globales y transiciones demogr√°ficas en el conjunto de pa√≠ses analizados.

------------------------------------------------------------------------

## An√°lisis de tendencias temporales por continente

### Evoluci√≥n de la esperanza de vida por continente

```{r}
# Gr√°fico de esperanza de vida vs tiempo por continente
ggplot(gapminder, aes(x = year, y = lifeExp, color = continent)) +
  geom_point(alpha = 0.3) +
  geom_smooth(method = "loess", se = TRUE) +
  labs(
    title = "Evoluci√≥n de la esperanza de vida por continente",
    x = "A√±o",
    y = "Esperanza de vida",
    color = "Continente"
  ) +
  theme_minimal(base_size = 12) +
  scale_color_brewer(palette = "Set2")
```

> Este gr√°fico muestra c√≥mo la esperanza de vida ha evolucionado de manera diferente en cada continente. Las bandas sombreadas representan el intervalo de confianza de la tendencia LOESS, revelando tanto la tendencia central como la variabilidad en cada regi√≥n.

### Evoluci√≥n del PBI per c√°pita por continente

```{r}
# Gr√°fico de PBI per c√°pita vs tiempo por continente
ggplot(gapminder, aes(x = year, y = gdpPercap, color = continent)) +
  geom_point(alpha = 0.3) +
  geom_smooth(method = "loess", se = TRUE) +
  labs(
    title = "Evoluci√≥n del PBI per c√°pita por continente",
    x = "A√±o",
    y = "PBI per c√°pita",
    color = "Continente"
  ) +
  theme_minimal(base_size = 12) +
  scale_color_brewer(palette = "Set2") +
  scale_y_continuous(labels = scales::dollar_format())
```

> La visualizaci√≥n del PBI per c√°pita revela patrones distintos de crecimiento econ√≥mico entre continentes. Las tendencias suavizadas LOESS y sus intervalos de confianza permiten apreciar tanto la magnitud como la variabilidad del desarrollo econ√≥mico en cada regi√≥n.

### Relaci√≥n entre esperanza de vida y PIB per c√°pita (2007)

```{r}
# Identificar top 10 pa√≠ses por esperanza de vida en 2007
top10_2007 <- gapminder %>%
  filter(year == 2007) %>%
  arrange(desc(lifeExp)) %>%
  slice_head(n = 10) %>%
  mutate(is_top10 = TRUE)

# Preparar datos para visualizaci√≥n
data_2007 <- gapminder %>%
  filter(year == 2007) %>%
  left_join(select(top10_2007, country, is_top10), by = "country") %>%
  mutate(
    is_top10 = replace_na(is_top10, FALSE),
    label = if_else(is_top10, country, NA_character_)
  )

# Crear gr√°fico
ggplot(data_2007, aes(x = gdpPercap, y = lifeExp)) +
  # Puntos base
  geom_point(aes(color = is_top10, size = is_top10, alpha = is_top10)) +
  # Etiquetas para top 10
  geom_text_repel(
    aes(label = label),
    nudge_x = 0.05,
    size = 3,
    segment.color = "grey50"
  ) +
  # L√≠nea de tendencia
  geom_smooth(method = "lm", color = "grey30", se = FALSE) +
  # Configuraci√≥n est√©tica
  scale_color_manual(
    values = c("FALSE" = "grey70", "TRUE" = "#e41a1c")
  ) +
  scale_size_manual(
    values = c("FALSE" = 2, "TRUE" = 3)
  ) +
  scale_alpha_manual(
    values = c("FALSE" = 0.5, "TRUE" = 1)
  ) +
  scale_x_log10(labels = scales::dollar_format()) +
  labs(
    title = "Relaci√≥n entre PIB per c√°pita y esperanza de vida (2007)",
    subtitle = "Destacando los 10 pa√≠ses con mayor esperanza de vida",
    x = "PIB per c√°pita (escala logar√≠tmica)",
    y = "Esperanza de vida"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    legend.position = "none",
    plot.subtitle = element_text(color = "grey40")
  )
```

> Esta visualizaci√≥n muestra la relaci√≥n entre PIB per c√°pita y esperanza de vida en 2007, destacando en rojo los 10 pa√≠ses con mayor esperanza de vida. Los pa√≠ses del top 10 tienden a concentrarse en la parte superior derecha del gr√°fico, confirmando la asociaci√≥n entre alto desarrollo econ√≥mico y mayor longevidad.

------------------------------------------------------------------------

## Visualizaciones de distribuciones antes y despu√©s de estandarizar variables

```{r}
# Visualizaci√≥n de distribuciones originales
tmp_orig <- gapminder %>%
  pivot_longer(cols = c(lifeExp, gdpPercap, pop),
               names_to = "variable", values_to = "valor")
ggplot(tmp_orig, aes(x = valor, fill = variable)) +
  geom_density(alpha = 0.6) +
  facet_wrap(~ variable, scales = "free") +
  labs(
    title = "Distribuciones de variables originales",
    x = "Valor",
    y = "Densidad"
  ) +
  theme_minimal()
```

```{r}
# Visualizaci√≥n de distribuciones estandarizadas
tmp_scaled <- gapminder %>%
  mutate(
    z_lifeExp = as.numeric(scale(lifeExp)),
    z_gdpPercap = as.numeric(scale(gdpPercap)),
    z_pop = as.numeric(scale(pop))
  ) %>%
  pivot_longer(
    cols = starts_with("z_"),
    names_to = "variable", values_to = "valor"
  ) %>%
  mutate(variable = sub("^z_", "", variable))
ggplot(tmp_scaled, aes(x = valor, fill = variable)) +
  geom_density(alpha = 0.6) +
  facet_wrap(~ variable, scales = "free") +
  labs(
    title = "Distribuciones de variables estandarizadas",
    x = "Valor estandarizado",
    y = "Densidad"
  ) +
  theme_minimal()
```

### Confirmar media y desviaci√≥n de variables estandarizadas

```{r}
# Calcular media y sd usando el objeto tmp_scaled generado anteriormente
summary_estandarizado_aux <- tmp_scaled %>%
  group_by(variable) %>%
  summarise(
    media = mean(valor, na.rm = TRUE),
    desvio = sd(valor, na.rm = TRUE),
    .groups = "drop"
  )

# Mostrar resultados
summary_estandarizado_aux %>%
  knitr::kable(
    caption = "Media y desviaci√≥n est√°ndar de variables estandarizadas"
  )
```

## Visualizaciones para ejercicio 1.14

```{r}
data_change <- gapminder %>%
  group_by(country) %>%
  arrange(year) %>%
  mutate(lifeExp_diff = lifeExp - lag(lifeExp)) %>%
  filter(year == 2007) %>%
  mutate(change = if_else(lifeExp_diff > 0, "Aument√≥", "No aument√≥"))

data_change %>%
  ggplot(aes(x = change, y = gdpPercap, color = change)) +
  geom_jitter(width = 0.2, alpha = 0.6, size = 2) +
  stat_summary(fun = mean, geom = "point", shape = 18, size = 4, color = "black") +
  labs(
    title = "GDP per c√°pita en 2007 seg√∫n cambio en esperanza de vida",
    x = "Cambio en lifeExp",
    y = "GDP per c√°pita (USD)"
  ) +
  theme_minimal()
```

> Se observa que la mayor√≠a de los pa√≠ses experimentaron un aumento en la esperanza de vida entre 2002 y 2007. Dentro de ese grupo, hay una gran dispersi√≥n en el ingreso per c√°pita, incluyendo tanto pa√≠ses de ingresos bajos como muy altos. En contraste, los pocos pa√≠ses donde no aument√≥ la esperanza de vida presentan niveles consistentemente bajos de ingreso. Esto refuerza la asociaci√≥n entre desarrollo econ√≥mico y mejora en indicadores de salud.

```{r}
data_change %>%
  ggplot(aes(x = gdpPercap, y = change, fill = change)) +
  geom_density_ridges(scale = 1.5, alpha = 0.6, show.legend = FALSE) +
  labs(
    title = "Distribuci√≥n de GDP per c√°pita seg√∫n cambio en esperanza de vida (2007)",
    x = "GDP per c√°pita",
    y = ""
  ) +
  theme_minimal()
```

> Aunque el gr√°fico es est√©ticamente atractivo, puede ser enga√±oso, especialmente en el grupo "No aument√≥", que contiene muy pocos pa√≠ses. La suavizaci√≥n genera una ilusi√≥n de densidad o volumen que en realidad no representa la escasez de datos. Por eso, es clave aclarar que las curvas no reflejan tama√±os muestrales proporcionales y que deben interpretarse con precauci√≥n.

------------------------------------------------------------------------

# Paleta para continentes con colores consistentes

```{r}
paleta_continentes <- scale_color_brewer(palette = "Set1")
paleta_fill_continentes <- scale_fill_brewer(palette = "Set1")
```

# 2.3: Facet wrap de `gdpPercap` seg√∫n a√±o

## üìä Gr√°fico 1: Escala original (prototipo exploratorio)

```{r}
#| label: ejercicio_23_prototipo_lineal
# Facet wrap de `gdpPercap` seg√∫n a√±o ‚Äî escala original
g1 <- ggplot(gapminder, aes(x = gdpPercap, fill = continent)) +
  geom_density(alpha = 0.5) +
  scale_x_continuous(labels = scales::label_number(scale_cut = scales::cut_short_scale())) +
  facet_wrap(~year, nrow = 3, ncol = 4) +
  labs(
    title = "Facet wrap de PIB per c√°pita seg√∫n a√±o",
    subtitle = "Versi√≥n preliminar con escala original ‚Äî prototipo visual sujeto a revisi√≥n",
    x = "PIB per c√°pita (USD)",
    y = "Densidad",
    fill = "Continente"
  ) +
  theme_minimal() +
  paleta_fill_continentes

g1
```

## üìä Gr√°fico 2: Escala logar√≠tmica (prototipo exploratorio)

```{r}
#| label: ejercicio_23_prototipo_log
# Facet wrap de `gdpPercap` seg√∫n a√±o ‚Äî escala logar√≠tmica
g2 <- ggplot(gapminder, aes(x = gdpPercap, fill = continent)) +
  geom_density(alpha = 0.5) +
  scale_x_log10(labels = scales::label_log()) +
  facet_wrap(~year, nrow = 3, ncol = 4) +
  labs(
    title = "Facet wrap de PIB per c√°pita seg√∫n a√±o",
    subtitle = "Versi√≥n preliminar con escala logar√≠tmica ‚Äî distribuci√≥n a√∫n no optimizada",
    x = "PIB per c√°pita (USD, escala log)",
    y = "Densidad",
    fill = "Continente"
  ) +
  theme_minimal() +
  paleta_fill_continentes
g2
```

## ‚úÖ Alternativa 1: Gr√°fico de l√≠nea apilada (√°rea) de proporciones de `gdpPercap √ó pop` por continente

### Qu√© muestra:

-   Proporci√≥n del ingreso total mundial aportado por cada continente en cada a√±o (ingreso total = `gdpPercap * pop`).
-   Facetear por a√±o no tiene sentido ac√°, as√≠ que **esta opci√≥n es complementaria, no sustituta** de 2.3.

```{r}
gapminder %>%
  mutate(ingreso_total = gdpPercap * pop) %>%
  group_by(year, continent) %>%
  summarise(ingreso = sum(ingreso_total), .groups = "drop") %>%
  group_by(year) %>%
  mutate(prop = ingreso / sum(ingreso)) %>%
  ggplot(aes(x = year, y = prop, fill = continent)) +
  geom_area(alpha = 0.8) +
  scale_y_continuous(labels = scales::percent_format()) +
  scale_fill_brewer(palette = "Set1") +
  labs(
    title = "Proporci√≥n del PIB mundial aportado por continente",
    x = "A√±o",
    y = "Proporci√≥n del ingreso total",
    fill = "Continente"
  ) +
  theme_minimal()
```

## ‚úÖ Alternativa 2: Histograma facetado (`gdpPercap` con continentes)

### Qu√© muestra:

-   Distribuci√≥n de pa√≠ses seg√∫n su PIB per c√°pita.
-   Escala logar√≠tmica para evitar la distorsi√≥n por outliers.
-   Cada panel representa un a√±o ‚Üí **respeta literalmente la consigna**.

```{r}
g1 <- gapminder %>%
  ggplot(aes(x = gdpPercap, fill = continent)) +
  geom_histogram(bins = 25, alpha = 0.5, position = "identity") +
  scale_x_continuous(labels = scales::label_number(scale_cut = scales::cut_short_scale())) +
  facet_wrap(~ year, ncol = 4) +
  labs(
    title = "Distribuci√≥n del PIB per c√°pita por a√±o",
    subtitle = "Escala original",
    x = "PIB per c√°pita (USD)",
    y = "Frecuencia",
    fill = "Continente"
  ) +
  theme_minimal() +
  paleta_fill_continentes

g1

g2 <- gapminder %>%
  ggplot(aes(x = log10(gdpPercap), fill = continent)) +
  geom_histogram(bins = 25, alpha = 0.5, position = "identity") +
  scale_x_log10(labels = scales::label_log()) +
  facet_wrap(~ year, ncol = 4) +
  labs(
    title = "Distribuci√≥n logar√≠tmica del PIB per c√°pita por a√±o",
    subtitle = "Facetas por a√±o, escala log10",
    x = "PIB per c√°pita (escala log)",
    y = "Frecuencia",
    fill = "Continente"
  ) +
  theme_minimal() +
  paleta_fill_continentes

g2
```

## ‚úÖ Alternativa 3: **Evoluci√≥n de la mediana de `gdpPercap` por continente (l√≠nea temporal)**

Este gr√°fico muestra c√≥mo evoluciona el nivel t√≠pico (mediana) del PIB per c√°pita en cada continente. Es ideal para mostrar tendencias macroecon√≥micas.

```{r}
g1 <- gapminder %>%
  group_by(year, continent) %>%
  summarise(median_gdp = median(gdpPercap), .groups = "drop") %>%
  ggplot(aes(x = year, y = median_gdp, color = continent)) +
  geom_line(size = 1) +
  geom_point(size = 1.5) +
  scale_y_continuous(labels = scales::label_number(scale_cut = scales::cut_short_scale())) +
  labs(
    title = "Evoluci√≥n de la mediana del PIB per c√°pita por continente",
    subtitle = "Escala original",
    x = "A√±o",
    y = "Mediana del PIB per c√°pita (USD)",
    color = "Continente"
  ) +
  theme_minimal() +
  paleta_continentes

g1

g2 <- gapminder %>%
  group_by(year, continent) %>%
  summarise(median_gdp = median(gdpPercap), .groups = "drop") %>%
  ggplot(aes(x = year, y = median_gdp, color = continent)) +
  geom_line(size = 1) +
  geom_point(size = 1.5) +
  scale_y_log10(labels = scales::label_log()) +
  labs(
    title = "Evoluci√≥n de la mediana del PIB per c√°pita por continente",
    x = "A√±o",
    y = "Mediana del PIB per c√°pita (USD, log)",
    color = "Continente"
  ) +
  theme_minimal() +
  paleta_continentes

g2
```

------------------------------------------------------------------------

## ‚úÖ Alternativa 4: **Evoluci√≥n de toda la distribuci√≥n ‚Äî faceteado por a√±o + violines**

Esto s√≠ cumple estrictamente con la consigna *"Facet wrap seg√∫n a√±o"*, pero en lugar de usar `geom_density()`, usamos **violin plots** para mostrar la dispersi√≥n y forma en cada panel:

```{r}
g1 <- gapminder %>%
  ggplot(aes(x = continent, y = gdpPercap, fill = continent)) +
  geom_violin(scale = "width", draw_quantiles = c(0.25, 0.5, 0.75)) +
  scale_y_continuous(labels = scales::label_number(scale_cut = scales::cut_short_scale())) +
  facet_wrap(~ year, ncol = 4) +
  labs(
    title = "Distribuci√≥n del PIB per c√°pita por continente en cada a√±o",
    subtitle = "Escala original",
    x = "Continente",
    y = "PIB per c√°pita (USD)",
    fill = "Continente"
  ) +
  theme_minimal() +
  paleta_fill_continentes +
  theme(axis.text.x = element_text(angle = 30, hjust = 1))

g1

g2 <- gapminder %>%
  ggplot(aes(x = continent, y = gdpPercap, fill = continent)) +
  geom_violin(scale = "width", draw_quantiles = c(0.25, 0.5, 0.75)) +
  scale_y_log10(labels = scales::label_log()) +
  facet_wrap(~year, ncol = 4) +
  labs(
    title = "Distribuci√≥n del PIB per c√°pita por continente en cada a√±o",
    subtitle = "Escala logar√≠tmica para evitar distorsi√≥n por outliers",
    x = "Continente",
    y = "PIB per c√°pita (USD, log escala)",
    fill = "Continente"
  ) +
  theme_minimal() +
  paleta_fill_continentes +
  theme(axis.text.x = element_text(angle = 30, hjust = 1))

g2
```

## ‚úÖ **Alternativa 5: Histograma facetado de `log(gdpPercap)` por a√±o (sin continentes)**

```{r}
#| label: ejercicio_23_histograma

g1 <- gapminder %>%
  ggplot(aes(x = gdpPercap)) +
  geom_histogram(bins = 25, fill = "steelblue", color = "white", alpha = 0.8) +
  scale_x_continuous(labels = scales::label_number(scale_cut = scales::cut_short_scale())) +
  facet_wrap(~ year, ncol = 4) +
  labs(
    title = "Distribuci√≥n del PIB per c√°pita por a√±o",
    subtitle = "Sin separar por continente ‚Äî escala original",
    x = "PIB per c√°pita (USD)",
    y = "Frecuencia"
  ) +
  theme_minimal()

g1

g2 <- gapminder %>%
  ggplot(aes(x = log10(gdpPercap))) +
  geom_histogram(bins = 25, fill = "steelblue", color = "white", alpha = 0.8) +
  scale_x_log10(labels = scales::label_log()) +
  facet_wrap(~ year, ncol = 4) +
  labs(
    title = "Distribuci√≥n del PIB per c√°pita (escala log) por a√±o",
    subtitle = "Se muestra la distribuci√≥n de pa√≠ses sin separar por continente",
    x = "PIB per c√°pita (escala log)",
    y = "Frecuencia"
  ) +
  theme_minimal()

g2
```

------------------------------------------------------------------------

## ‚úÖ **Alternativa 6: Diagrama de viol√≠n facetado por a√±o (sin continentes)**

```{r}
#| label: ejercicio_23_violin

# Escala original
g1 <- gapminder %>%
  ggplot(aes(x = factor(year), y = gdpPercap)) +
  geom_violin(fill = "darkorange", alpha = 0.7,
              draw_quantiles = c(0.25, 0.5, 0.75)) +
  scale_y_continuous(labels = scales::label_number(scale_cut = scales::cut_short_scale())) +
  labs(
    title = "Distribuci√≥n del PIB per c√°pita por a√±o",
    subtitle = "Violines verticales ‚Äî escala original",
    x = "A√±o",
    y = "PIB per c√°pita (USD)"
  ) +
  theme_minimal()

# Escala logar√≠tmica
g2 <- gapminder %>%
  ggplot(aes(x = factor(year), y = gdpPercap)) +
  geom_violin(fill = "darkorange", alpha = 0.7,
              draw_quantiles = c(0.25, 0.5, 0.75)) +
  scale_y_log10(labels = scales::label_log()) +
  labs(
    title = "Distribuci√≥n del PIB per c√°pita por a√±o (escala log)",
    subtitle = "Violines verticales ‚Äî escala logar√≠tmica",
    x = "A√±o",
    y = "PIB per c√°pita (USD, log escala)"
  ) +
  theme_minimal()

# Visualizaci√≥n
g1
g2
```

## ‚úÖ **Alternativa 7: Split‚Äêviolin de `gdpPercap` vs `lag(gdpPercap)` por continente

```{r}
# Preparo datos con lag de 1 a√±o por pa√≠s
df_halves <- gapminder %>%
  group_by(country) %>%
  arrange(year) %>%
  mutate(lag_gdp = lag(gdpPercap)) %>%
  ungroup() %>%
  filter(!is.na(lag_gdp))

# Split‚Äêviolin en log‚Äêescala, faceteado por a√±o
ggplot(df_halves, aes(x = continent, fill = continent)) +
  geom_half_violin(
    aes(y = lag_gdp),
    side  = "l",
    alpha = 0.6,
    scale = "width",
    trim  = FALSE
  ) +
  geom_half_violin(
    aes(y = gdpPercap),
    side  = "r",
    alpha = 0.6,
    scale = "width",
    trim  = FALSE
  ) +
  scale_y_log10(labels = label_log()) +
  facet_wrap(~year, ncol = 4) +
  labs(
    title    = "PIB per c√°pita: lag vs actual cada a√±o",
    subtitle = "Violin por continente (escala log)",
    y        = "PIB per c√°pita (USD, log escala)",
    fill     = "Continente"
  ) +
  theme_minimal() +
  paleta_fill_continentes +
  theme(
    axis.text.x = element_text(angle = 30, hjust = 1),
    legend.position = c(0.9, 0.025)
  )
```

## ‚úÖ **Diagrama de mosaico de `continent` contra una categor√≠a derivada de `lifeExp`**

```{r}
library(ggalluvial)

data_mosaic <- gapminder %>%
  mutate(
    lifeExp_cat = case_when(
      lifeExp < 50 ~ "baja",
      lifeExp < 70 ~ "media",
      TRUE         ~ "alta"
    )
  )

data_mosaic %>%
  count(continent, lifeExp_cat) %>%
  ggplot(aes(axis1 = continent, axis2 = lifeExp_cat, y = n)) +
  geom_alluvium(aes(fill = lifeExp_cat), width = 1/12, alpha = 0.8) +
  geom_stratum(width = 1/12, fill = "grey90") +
  geom_label(stat = "stratum", aes(label = after_stat(stratum))) +
  scale_x_discrete(
    limits = c("continent", "lifeExp_cat"),
    expand = c(.1, .1)
  ) +
  labs(
    title = "Alluvial: flujo de pa√≠ses por categor√≠a de esperanza",
    x     = "",
    y     = "Cantidad de pa√≠ses",
    fill  = "LifeExp"
  ) +
  theme_minimal(base_size = 12)

```
